<script is:inline>
	const lightModePref = window.matchMedia('(prefers-color-scheme: light)')

	// Get system theme
	function getSystemTheme() {
		return lightModePref.matches ? 'light' : 'dark'
	}

	// Get user preference from local storage or default to system
	function getUserPref() {
		const storedTheme = localStorage.getItem('theme')
		return storedTheme || 'system'
	}

	function setTheme(newTheme) {
		if (newTheme !== 'light' && newTheme !== 'dark' && newTheme !== 'system') {
			return console.log(
				`Invalid theme value '${newTheme}' received. Expected 'light', 'dark', or 'system'.`
			)
		}

		localStorage.setItem('theme', newTheme)

		const root = document.documentElement
		const effectiveTheme = newTheme === 'system' ? getSystemTheme() : newTheme

		// if current dark theme and new theme is dark, return
		if (effectiveTheme === 'dark' && root.classList.contains('dark')) {
			return
		} else if (effectiveTheme === 'light' && !root.classList.contains('dark')) {
			return
		}

		root.classList.toggle('dark')
		root.setAttribute('data-theme', effectiveTheme)
	}

	// Initial Setup
	setTheme(getUserPref())

	// View Transitions hook to restore theme
	document.addEventListener('astro:after-swap', () => setTheme(getUserPref()))

	// Listen for theme-change custom event
	document.addEventListener('theme-change', (e) => {
		setTheme(e.detail.theme)
	})

	// Listen for prefers-color-scheme change (only when system mode is active)
	lightModePref.addEventListener('change', (e) => {
		const currentPref = getUserPref()
		if (currentPref === 'system') {
			setTheme('system')
		}
	})
</script>
